{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="card">
    <div class="dashboard-header">
        <h1>Candidates Dashboard</h1>
        <div class="dashboard-actions">
            <form action="{{ url_for('admin_delete_all') }}" method="POST"
                  onsubmit="return confirm('Delete ALL candidates and uploaded files? This cannot be undone.')">
                <button type="submit" class="btn btn-danger btn-sm">Delete All</button>
            </form>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary btn-sm">Logout</a>
        </div>
    </div>

    <div class="filter-bar">
        <span>Filter by job:</span>
        <a href="{{ url_for('admin_dashboard', job='all') }}"
           class="btn btn-sm {% if current_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">All</a>
        {% for id, job in job_ads.items() %}
        <a href="{{ url_for('admin_dashboard', job=id) }}"
           class="btn btn-sm {% if current_filter == id %}btn-primary{% else %}btn-secondary{% endif %}">{{ job.title }}</a>
        {% endfor %}
    </div>

    <details class="scoring-explainer">
        <summary class="btn btn-sm btn-secondary">How ATS Scoring Works</summary>
        <div class="scoring-explainer-body">
            <h3>Pipeline</h3>
            <ol>
                <li><strong>Text extraction</strong> — PDF text is pulled out page-by-page with pdfplumber.</li>
                <li><strong>Normalization</strong> — Both the CV text and each keyword are lowercased, special characters (except <code>/</code> <code>+</code> <code>#</code>) are replaced with spaces, and whitespace is collapsed.</li>
                <li><strong>Substring matching</strong> — Each keyword is checked as a substring of the normalized CV text. No stemming, no synonyms, no fuzzy matching.</li>
                <li><strong>Weighted score</strong> — Must-have keywords are worth <strong>3 points</strong>, nice-to-have worth <strong>1 point</strong>. Formula: <code>(must_matched&times;3 + nice_matched&times;1) &divide; (must_total&times;3 + nice_total&times;1) &times; 100</code>, rounded to one decimal.</li>
            </ol>
            <h3>Score thresholds</h3>
            <table class="table">
                <thead><tr><th>Range</th><th>Color</th><th>Label</th></tr></thead>
                <tbody>
                    <tr><td>&ge; 70 %</td><td><span class="score-badge score-high">green</span></td><td>High match</td></tr>
                    <tr><td>40 – 69 %</td><td><span class="score-badge score-medium">orange</span></td><td>Medium match</td></tr>
                    <tr><td>&lt; 40 %</td><td><span class="score-badge score-low">red</span></td><td>Low match</td></tr>
                </tbody>
            </table>
            <h3>Keywords per job</h3>
            <ul>
                {% for id, job in job_ads.items() %}
                <li><strong>{{ job.title }}</strong> ({{ job.company }}) — {{ job.keywords.must_have|length }} must-have + {{ job.keywords.nice_to_have|length }} nice-to-have</li>
                {% endfor %}
            </ul>
            <h3>Limitations</h3>
            <ul>
                <li>Exact substring only — "React.js" in a CV won't match keyword <code>react</code> if the dot is stripped differently.</li>
                <li>Only two weight tiers (must-have 3 pts, nice-to-have 1 pt) — real systems use more granular weighting.</li>
                <li>No semantic understanding — "built web UIs" won't match <code>frontend</code>.</li>
            </ul>
        </div>
    </details>

    {% if candidates %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Job Position</th>
                    <th>Score</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for c in candidates %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ c.name }}</td>
                    <td>{{ job_ads[c.job_id].title if c.job_id in job_ads else c.job_id }}</td>
                    <td>
                        <span class="score-badge
                            {% if c.score >= 70 %}score-high
                            {% elif c.score >= 40 %}score-medium
                            {% else %}score-low{% endif %}">
                            {{ c.score }}%
                        </span>
                    </td>
                    <td>{{ c.created_at }}</td>
                    <td>
                        <a href="{{ url_for('admin_candidate', candidate_id=c.id) }}" class="btn btn-sm btn-primary">View</a>
                        <a href="{{ url_for('admin_pdf', candidate_id=c.id) }}" class="btn btn-sm btn-secondary" target="_blank">PDF</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-state">No candidates yet. Share the upload link with participants!</p>
    {% endif %}
</div>
{% endblock %}
